#@ load("@ytt:data", "data")
#@ load("@ytt:overlay", "overlay")
#@ load("@ytt:base64", "base64")
#@ load("@ytt:yaml", "yaml")

#! Deskrun-specific overlay for customizing the base templates
#! This overlay applies customizations for:
#! - Instance naming (names, labels)
#! - GitHub repository and auth configuration
#! - Privileged mode specific: cache volumes and hook extensions

#! Function to build hook extension ConfigMap content for privileged mode
#@ def build_hook_extension_spec():
#@   spec = {}
#@   spec["hostPID"] = True
#@   spec["hostIPC"] = True
#@   spec["securityContext"] = {"runAsUser": 0, "runAsGroup": 0, "fsGroup": 0}
#@   
#@   # Build init container to set up glibc compatibility layer AND copy node externals.
#@   # This enables Nixery images to run GitHub Actions' node binary which requires glibc.
#@   # We copy glibc libs from the actions-runner image (Ubuntu-based) which has FHS-compatible
#@   # library paths hardcoded in the dynamic linker. This avoids needing apt-get install.
#@   # We also copy the node externals from /home/runner/externals to /__e since the job
#@   # container runs in a separate pod and doesn't share filesystem with the runner.
#@   initContainer = {
#@     "name": "setup-glibc-compat",
#@     "image": "ghcr.io/actions/actions-runner:latest",
#@     "command": ["sh", "-c"],
#@     "args": [
#@       "for lib in ld-linux-x86-64.so.2 libc.so.6 libm.so.6 libpthread.so.0 libdl.so.2 librt.so.1 libstdc++.so.6 libgcc_s.so.1; do " +
#@       "[ -f \"/lib/x86_64-linux-gnu/$lib\" ] && cp -L \"/lib/x86_64-linux-gnu/$lib\" /glibc-compat/; done; " +
#@       "chmod 755 /glibc-compat/*; " +
#@       "cp -r /home/runner/externals/* /externals/"
#@     ],
#@     "volumeMounts": [
#@       {"name": "glibc-compat", "mountPath": "/glibc-compat"},
#@       {"name": "externals", "mountPath": "/externals"}
#@     ]
#@   }
#@   spec["initContainers"] = [initContainer]
#@   
#@   # Build container spec
#@   container = {}
#@   container["name"] = "$job"
#@   container["securityContext"] = {
#@     "privileged": True,
#@     "runAsUser": 0,
#@     "runAsGroup": 0,
#@     "allowPrivilegeEscalation": True,
#@     "capabilities": {
#@       "add": [
#@         "SYS_ADMIN", "NET_ADMIN", "SYS_PTRACE", "SYS_CHROOT",
#@         "SETFCAP", "SETPCAP", "NET_RAW", "IPC_LOCK",
#@         "SYS_RESOURCE", "MKNOD", "AUDIT_WRITE", "AUDIT_CONTROL"
#@       ]
#@     }
#@   }
#@   
#@   # Build volumeMounts
#@   # Note: externals (/__e), work (/__w), and github (/github) volumes/mounts are automatically
#@   # added by the k8s-novolume hooks, so we don't include them here to avoid duplicates.
#@   # The init container populates the hooks' externals volume with node binaries.
#@   volumeMounts = [
#@     {"name": "sys", "mountPath": "/sys"},
#@     {"name": "cgroup", "mountPath": "/sys/fs/cgroup", "mountPropagation": "Bidirectional"},
#@     {"name": "proc", "mountPath": "/proc"},
#@     {"name": "dev", "mountPath": "/dev"},
#@     {"name": "dev-pts", "mountPath": "/dev/pts"},
#@     {"name": "shm", "mountPath": "/dev/shm"},
#@     {"name": "glibc-compat", "mountPath": "/lib64"},
#@     {"name": "glibc-compat", "mountPath": "/lib/x86_64-linux-gnu"}
#@   ]
#@   
#@   # Add cache path volume mounts
#@   for i, cachePath in enumerate(data.values.installation.cachePaths):
#@     volumeMounts.append({"name": "cache-" + str(i), "mountPath": cachePath.target})
#@   end
#@   
#@   # Note: externals (/__e), work (/__w), and github (/github) volumes are automatically
#@   # added by the k8s-novolume hooks, so we don't include them here to avoid duplicates.
#@   # The hooks handle all GitHub workspace paths including /github/workflow/event.json
#@   
#@   container["volumeMounts"] = volumeMounts
#@   
#@   # Build volumes
#@   # Note: externals, work, and github volumes are automatically added by the
#@   # k8s-novolume hooks, so we don't include them here to avoid duplicates.
#@   volumes = [
#@     {"name": "sys", "hostPath": {"path": "/sys", "type": "Directory"}},
#@     {"name": "cgroup", "hostPath": {"path": "/sys/fs/cgroup", "type": "Directory"}},
#@     {"name": "proc", "hostPath": {"path": "/proc", "type": "Directory"}},
#@     {"name": "dev", "hostPath": {"path": "/dev", "type": "Directory"}},
#@     {"name": "dev-pts", "hostPath": {"path": "/dev/pts", "type": "Directory"}},
#@     {"name": "shm", "hostPath": {"path": "/dev/shm", "type": "Directory"}},
#@     {"name": "glibc-compat", "emptyDir": {}}
#@   ]
#@   
#@   # Add cache path volumes
#@   for i, cachePath in enumerate(data.values.installation.cachePaths):
#@     cache_source = cachePath.source
#@     if cache_source == "":
#@       instance_num = data.values.installation.instanceNum if hasattr(data.values.installation, "instanceNum") else 0
#@       if instance_num > 0:
#@         cache_source = "/tmp/github-runner-cache/" + data.values.installation.name + "-" + str(instance_num) + "/cache-" + str(i)
#@       else:
#@         cache_source = "/tmp/github-runner-cache/" + data.values.installation.name + "/cache-" + str(i)
#@       end
#@     end
#@     volumes.append({"name": "cache-" + str(i), "hostPath": {"path": cache_source, "type": "DirectoryOrCreate"}})
#@   end
#@   
#@   spec["containers"] = [container]
#@   spec["volumes"] = volumes
#@   
#@   return {"spec": spec}
#@ end

#! Apply name transformations to Secret
#! The Secret must be deleted AFTER the AutoscalingRunnerSet because the ARC controller
#! needs the secret to authenticate with GitHub when deregistering the runner scale set.
#@overlay/match by=overlay.subset({"kind":"Secret"}),expects="0+"
---
metadata:
  #@overlay/match missing_ok=True
  name: #@ data.values.installation.name + "-gha-rs-github-secret"
  labels:
    #@overlay/match missing_ok=True
    app.kubernetes.io/name: #@ data.values.installation.name
    #@overlay/match missing_ok=True
    app.kubernetes.io/instance: #@ data.values.installation.name
    #@overlay/match missing_ok=True
    actions.github.com/scale-set-name: #@ data.values.installation.name
  annotations:
    #@overlay/match missing_ok=True
    kapp.k14s.io/change-group: #@ "arc-secret/" + data.values.installation.name
    #@overlay/match missing_ok=True
    kapp.k14s.io/change-rule.delete: #@ "delete after deleting arc-ars/" + data.values.installation.name
data:
  #@overlay/match missing_ok=True
  github_token: #@ base64.encode(data.values.installation.authValue)

#! Apply name transformations to no-permission ServiceAccount (dind mode)
#@overlay/match by=overlay.subset({"kind":"ServiceAccount","metadata":{"name":"arc-runner-gha-rs-no-permission"}}),expects="0+"
---
metadata:
  #@overlay/match missing_ok=True
  name: #@ data.values.installation.name + "-gha-rs-no-permission"
  labels:
    #@overlay/match missing_ok=True
    app.kubernetes.io/name: #@ data.values.installation.name
    #@overlay/match missing_ok=True
    app.kubernetes.io/instance: #@ data.values.installation.name
    #@overlay/match missing_ok=True
    actions.github.com/scale-set-name: #@ data.values.installation.name

#! Apply name transformations to kube-mode ServiceAccount (kubernetes/privileged mode)
#@overlay/match by=overlay.subset({"kind":"ServiceAccount","metadata":{"name":"arc-runner-gha-rs-kube-mode"}}),expects="0+"
---
metadata:
  #@overlay/match missing_ok=True
  name: #@ data.values.installation.name + "-gha-rs-kube-mode"
  labels:
    #@overlay/match missing_ok=True
    app.kubernetes.io/name: #@ data.values.installation.name
    #@overlay/match missing_ok=True
    app.kubernetes.io/instance: #@ data.values.installation.name
    #@overlay/match missing_ok=True
    actions.github.com/scale-set-name: #@ data.values.installation.name

#! Apply name transformations to manager Role
#@overlay/match by=overlay.subset({"kind":"Role","metadata":{"labels":{"app.kubernetes.io/component":"manager-role"}}}),expects="0+"
---
metadata:
  #@overlay/match missing_ok=True
  name: #@ data.values.installation.name + "-gha-rs-manager"
  labels:
    #@overlay/match missing_ok=True
    app.kubernetes.io/name: #@ data.values.installation.name
    #@overlay/match missing_ok=True
    app.kubernetes.io/instance: #@ data.values.installation.name
    #@overlay/match missing_ok=True
    actions.github.com/scale-set-name: #@ data.values.installation.name

#! Apply name transformations to kube-mode Role (kubernetes/privileged mode)
#@overlay/match by=overlay.subset({"kind":"Role","metadata":{"name":"arc-runner-gha-rs-kube-mode"}}),expects="0+"
---
metadata:
  #@overlay/match missing_ok=True
  name: #@ data.values.installation.name + "-gha-rs-kube-mode"
  labels:
    #@overlay/match missing_ok=True
    app.kubernetes.io/name: #@ data.values.installation.name
    #@overlay/match missing_ok=True
    app.kubernetes.io/instance: #@ data.values.installation.name
    #@overlay/match missing_ok=True
    actions.github.com/scale-set-name: #@ data.values.installation.name

#! Apply name transformations to manager RoleBinding
#@overlay/match by=overlay.subset({"kind":"RoleBinding","metadata":{"labels":{"app.kubernetes.io/component":"manager-role-binding"}}}),expects="0+"
---
metadata:
  #@overlay/match missing_ok=True
  name: #@ data.values.installation.name + "-gha-rs-manager"
  labels:
    #@overlay/match missing_ok=True
    app.kubernetes.io/name: #@ data.values.installation.name
    #@overlay/match missing_ok=True
    app.kubernetes.io/instance: #@ data.values.installation.name
    #@overlay/match missing_ok=True
    actions.github.com/scale-set-name: #@ data.values.installation.name
roleRef:
  #@overlay/match missing_ok=True
  name: #@ data.values.installation.name + "-gha-rs-manager"

#! Apply name transformations to kube-mode RoleBinding (kubernetes/privileged mode)
#@overlay/match by=overlay.subset({"kind":"RoleBinding","metadata":{"name":"arc-runner-gha-rs-kube-mode"}}),expects="0+"
---
metadata:
  #@overlay/match missing_ok=True
  name: #@ data.values.installation.name + "-gha-rs-kube-mode"
  labels:
    #@overlay/match missing_ok=True
    app.kubernetes.io/name: #@ data.values.installation.name
    #@overlay/match missing_ok=True
    app.kubernetes.io/instance: #@ data.values.installation.name
    #@overlay/match missing_ok=True
    actions.github.com/scale-set-name: #@ data.values.installation.name
roleRef:
  #@overlay/match missing_ok=True
  name: #@ data.values.installation.name + "-gha-rs-kube-mode"
subjects:
#@overlay/match by="name"
#@overlay/replace
- name: #@ data.values.installation.name + "-gha-rs-kube-mode"
  kind: ServiceAccount
  namespace: arc-systems

#! Apply base transformations to AutoscalingRunnerSet - dind mode specific annotations
#@ if data.values.installation.containerMode == "dind":
#@overlay/match by=overlay.subset({"kind":"AutoscalingRunnerSet"}),expects="0+"
---
metadata:
  #@overlay/match missing_ok=True
  name: #@ data.values.installation.name
  labels:
    #@overlay/match missing_ok=True
    app.kubernetes.io/name: #@ data.values.installation.name
    #@overlay/match missing_ok=True
    app.kubernetes.io/instance: #@ data.values.installation.name
    #@overlay/match missing_ok=True
    actions.github.com/scale-set-name: #@ data.values.installation.name
  annotations:
    #@overlay/match missing_ok=True
    kapp.k14s.io/change-group: #@ "arc-ars/" + data.values.installation.name
    #@overlay/match missing_ok=True
    actions.github.com/cleanup-github-secret-name: #@ data.values.installation.name + "-gha-rs-github-secret"
    #@overlay/match missing_ok=True
    actions.github.com/cleanup-manager-role-binding: #@ data.values.installation.name + "-gha-rs-manager"
    #@overlay/match missing_ok=True
    actions.github.com/cleanup-manager-role-name: #@ data.values.installation.name + "-gha-rs-manager"
    #@overlay/match missing_ok=True
    actions.github.com/cleanup-no-permission-service-account-name: #@ data.values.installation.name + "-gha-rs-no-permission"
spec:
  #@overlay/match missing_ok=True
  githubConfigUrl: #@ data.values.installation.repository
  #@overlay/match missing_ok=True
  githubConfigSecret: #@ data.values.installation.name + "-gha-rs-github-secret"
  template:
    spec:
      #@overlay/match missing_ok=True
      serviceAccountName: #@ data.values.installation.name + "-gha-rs-no-permission"
#@ end

#! Apply base transformations to AutoscalingRunnerSet - kubernetes mode specific annotations
#@ if data.values.installation.containerMode == "kubernetes":
#@overlay/match by=overlay.subset({"kind":"AutoscalingRunnerSet"}),expects="0+"
---
metadata:
  #@overlay/match missing_ok=True
  name: #@ data.values.installation.name
  labels:
    #@overlay/match missing_ok=True
    app.kubernetes.io/name: #@ data.values.installation.name
    #@overlay/match missing_ok=True
    app.kubernetes.io/instance: #@ data.values.installation.name
    #@overlay/match missing_ok=True
    actions.github.com/scale-set-name: #@ data.values.installation.name
  annotations:
    #@overlay/match missing_ok=True
    kapp.k14s.io/change-group: #@ "arc-ars/" + data.values.installation.name
    #@overlay/match missing_ok=True
    actions.github.com/cleanup-github-secret-name: #@ data.values.installation.name + "-gha-rs-github-secret"
    #@overlay/match missing_ok=True
    actions.github.com/cleanup-manager-role-binding: #@ data.values.installation.name + "-gha-rs-manager"
    #@overlay/match missing_ok=True
    actions.github.com/cleanup-manager-role-name: #@ data.values.installation.name + "-gha-rs-manager"
    #@overlay/match missing_ok=True
    actions.github.com/cleanup-kubernetes-mode-role-binding-name: #@ data.values.installation.name + "-gha-rs-kube-mode"
    #@overlay/match missing_ok=True
    actions.github.com/cleanup-kubernetes-mode-role-name: #@ data.values.installation.name + "-gha-rs-kube-mode"
    #@overlay/match missing_ok=True
    actions.github.com/cleanup-kubernetes-mode-service-account-name: #@ data.values.installation.name + "-gha-rs-kube-mode"
spec:
  #@overlay/match missing_ok=True
  githubConfigUrl: #@ data.values.installation.repository
  #@overlay/match missing_ok=True
  githubConfigSecret: #@ data.values.installation.name + "-gha-rs-github-secret"
  template:
    spec:
      #@overlay/match missing_ok=True
      serviceAccountName: #@ data.values.installation.name + "-gha-rs-kube-mode"
#@ end

#! Apply base transformations to AutoscalingRunnerSet - privileged mode specific
#@ if data.values.installation.containerMode == "cached-privileged-kubernetes":
#@overlay/match by=overlay.subset({"kind":"AutoscalingRunnerSet"}),expects="0+"
---
metadata:
  #@overlay/match missing_ok=True
  name: #@ data.values.installation.name
  labels:
    #@overlay/match missing_ok=True
    app.kubernetes.io/name: #@ data.values.installation.name
    #@overlay/match missing_ok=True
    app.kubernetes.io/instance: #@ data.values.installation.name
    #@overlay/match missing_ok=True
    actions.github.com/scale-set-name: #@ data.values.installation.name
  annotations:
    #@overlay/match missing_ok=True
    kapp.k14s.io/change-group: #@ "arc-ars/" + data.values.installation.name
    #@overlay/match missing_ok=True
    actions.github.com/cleanup-github-secret-name: #@ data.values.installation.name + "-gha-rs-github-secret"
    #@overlay/match missing_ok=True
    actions.github.com/cleanup-manager-role-binding: #@ data.values.installation.name + "-gha-rs-manager"
    #@overlay/match missing_ok=True
    actions.github.com/cleanup-manager-role-name: #@ data.values.installation.name + "-gha-rs-manager"
    #@overlay/match missing_ok=True
    actions.github.com/cleanup-kubernetes-mode-role-binding-name: #@ data.values.installation.name + "-gha-rs-kube-mode"
    #@overlay/match missing_ok=True
    actions.github.com/cleanup-kubernetes-mode-role-name: #@ data.values.installation.name + "-gha-rs-kube-mode"
    #@overlay/match missing_ok=True
    actions.github.com/cleanup-kubernetes-mode-service-account-name: #@ data.values.installation.name + "-gha-rs-kube-mode"
spec:
  #@overlay/match missing_ok=True
  githubConfigUrl: #@ data.values.installation.repository
  #@overlay/match missing_ok=True
  githubConfigSecret: #@ data.values.installation.name + "-gha-rs-github-secret"
  template:
    spec:
      #@overlay/match missing_ok=True
      serviceAccountName: #@ data.values.installation.name + "-gha-rs-kube-mode"
      #@overlay/match missing_ok=True
      securityContext:
        fsGroup: 123
      containers:
      #@overlay/match by="name"
      - name: runner
        #@overlay/match missing_ok=True
        securityContext:
          privileged: true
          allowPrivilegeEscalation: true
          readOnlyRootFilesystem: false
          runAsNonRoot: false
        env:
        #@overlay/match by="name"
        - name: ACTIONS_RUNNER_CONTAINER_HOOKS
          #@overlay/match missing_ok=True
          value: /home/runner/k8s-novolume/index.js
        #@overlay/append
        - name: ACTIONS_RUNNER_CONTAINER_HOOK_TEMPLATE
          value: /etc/hooks/content
        #@overlay/match by="name"
        - name: ACTIONS_RUNNER_REQUIRE_JOB_CONTAINER
          #@overlay/match missing_ok=True
          value: "false"
        #@overlay/replace
        volumeMounts:
        - name: hook-extension
          mountPath: /etc/hooks
          readOnly: true
        #@ for i, cachePath in enumerate(data.values.installation.cachePaths):
        - name: #@ "cache-" + str(i)
          mountPath: #@ cachePath.target
        #@ end
      #@overlay/replace
      volumes:
      - name: hook-extension
        configMap:
          name: #@ "privileged-hook-extension-" + data.values.installation.name
          defaultMode: 0755
      #@ for i, cachePath in enumerate(data.values.installation.cachePaths):
      - name: #@ "cache-" + str(i)
        #@ if cachePath.source == "":
        emptyDir: {}
        #@ else:
        hostPath:
          path: #@ cachePath.source
          type: DirectoryOrCreate
        #@ end
      #@ end
#@ end

#! ConfigMap overlay for privileged mode
#@ if data.values.installation.containerMode == "cached-privileged-kubernetes":
#@overlay/match by=overlay.subset({"kind":"ConfigMap","metadata":{"name":"privileged-hook-extension-arc-runner"}}),expects=1
---
metadata:
  #@overlay/match missing_ok=True
  name: #@ "privileged-hook-extension-" + data.values.installation.name
data:
  #@overlay/match missing_ok=True
  content: #@ yaml.encode(build_hook_extension_spec())
#@ end
