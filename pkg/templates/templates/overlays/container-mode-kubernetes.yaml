#@ load("@ytt:data", "data")
#@ load("@ytt:overlay", "overlay")

#! Overlay for kubernetes container mode (default)
#! This mode uses GitHub Actions runner in standard Kubernetes pod

#! Transform no-permission ServiceAccount
#@overlay/match by=overlay.subset({"kind":"ServiceAccount", "metadata": {"name": "arc-runner-gha-rs-no-permission"}}),expects=1
---
metadata:
  name: #@ data.values.installation.name + "-gha-rs-no-permission"
  labels:
    app.kubernetes.io/name: #@ data.values.installation.name
    app.kubernetes.io/instance: #@ data.values.installation.name
    actions.github.com/scale-set-name: #@ data.values.installation.name
  annotations:
    actions.github.com/cleanup-no-permission-service-account-name: #@ data.values.installation.name + "-gha-rs-no-permission"

#! Transform manager ServiceAccount
#@overlay/match by=overlay.subset({"kind":"ServiceAccount", "metadata": {"name": "arc-runner-gha-rs-manager"}}),expects=1
---
metadata:
  name: #@ data.values.installation.name + "-gha-rs-manager"
  labels:
    app.kubernetes.io/name: #@ data.values.installation.name
    app.kubernetes.io/instance: #@ data.values.installation.name
    actions.github.com/scale-set-name: #@ data.values.installation.name

#@overlay/match by=overlay.subset({"kind":"Secret"}),expects="0+"
---
metadata:
  name: #@ data.values.installation.name + "-gha-rs-github-secret"
  labels:
    app.kubernetes.io/name: #@ data.values.installation.name
    app.kubernetes.io/instance: #@ data.values.installation.name
    actions.github.com/scale-set-name: #@ data.values.installation.name
  annotations:
    actions.github.com/cleanup-github-secret-name: #@ data.values.installation.name + "-gha-rs-github-secret"
data:
  github_token: #@ data.values.installation.authValue

#@overlay/match by=overlay.subset({"kind":"Role"}),expects="0+"
---
metadata:
  name: #@ data.values.installation.name + "-gha-rs-manager"
  labels:
    app.kubernetes.io/name: #@ data.values.installation.name
    app.kubernetes.io/instance: #@ data.values.installation.name
    actions.github.com/scale-set-name: #@ data.values.installation.name
  annotations:
    actions.github.com/cleanup-manager-role-name: #@ data.values.installation.name + "-gha-rs-manager"

#@overlay/match by=overlay.subset({"kind":"RoleBinding"}),expects="0+"
---
metadata:
  name: #@ data.values.installation.name + "-gha-rs-manager"
  labels:
    app.kubernetes.io/name: #@ data.values.installation.name
    app.kubernetes.io/instance: #@ data.values.installation.name
    actions.github.com/scale-set-name: #@ data.values.installation.name
  annotations:
    actions.github.com/cleanup-manager-role-binding: #@ data.values.installation.name + "-gha-rs-manager"
roleRef:
  name: #@ data.values.installation.name + "-gha-rs-manager"

#@overlay/match by=overlay.subset({"kind":"AutoscalingRunnerSet"}),expects="0+"
---
metadata:
  name: #@ data.values.installation.name
  labels:
    app.kubernetes.io/name: #@ data.values.installation.name
    app.kubernetes.io/instance: #@ data.values.installation.name
    actions.github.com/scale-set-name: #@ data.values.installation.name
  annotations:
    actions.github.com/cleanup-github-secret-name: #@ data.values.installation.name + "-gha-rs-github-secret"
    actions.github.com/cleanup-manager-role-binding: #@ data.values.installation.name + "-gha-rs-manager"
    actions.github.com/cleanup-manager-role-name: #@ data.values.installation.name + "-gha-rs-manager"
    actions.github.com/cleanup-no-permission-service-account-name: #@ data.values.installation.name + "-gha-rs-no-permission"
spec:
  githubConfigUrl: #@ data.values.installation.repository
  githubConfigSecret: #@ data.values.installation.name + "-gha-rs-github-secret"
  
  template:
    spec:
      serviceAccountName: #@ data.values.installation.name + "-gha-rs-manager"
      containers:
      #@overlay/match by="name"
      - name: runner
        image: ghcr.io/actions/actions-runner:latest
        command: ["/home/runner/run.sh"]
        #@overlay/match missing_ok=True
        env:
        #@overlay/append
        - name: ACTIONS_RUNNER_REQUIRE_JOB_CONTAINER
          value: "true"
