#@ load("@ytt:data", "data")
#@ load("@ytt:overlay", "overlay")

#! Overlay for Docker-in-Docker (dind) container mode
#! This mode uses a sidecar Docker daemon container

#! Remove manager ServiceAccount - DinD mode doesn't need pod management permissions
#@overlay/match by=overlay.subset({"kind":"ServiceAccount","metadata":{"labels":{"app.kubernetes.io/component":"manager-serviceaccount"}}}),expects="0+"
#@overlay/remove
---

#! Remove manager Role - not needed for DinD mode
#@overlay/match by=overlay.subset({"kind":"Role","metadata":{"labels":{"app.kubernetes.io/component":"manager-role"}}}),expects="0+"
#@overlay/remove
---

#! Remove manager RoleBinding - not needed for DinD mode  
#@overlay/match by=overlay.subset({"kind":"RoleBinding","metadata":{"labels":{"app.kubernetes.io/component":"manager-role-binding"}}}),expects="0+"
#@overlay/remove
---

#@overlay/match by=overlay.subset({"kind":"AutoscalingRunnerSet"}),expects="0+"
---
spec:
  #@overlay/match missing_ok=True
  githubConfigUrl: #@ data.values.installation.repository
  
  template:
    spec:
      #! Use no-permission ServiceAccount for DinD mode
      serviceAccountName: #@ data.values.installation.name + "-gha-rs-no-permission"
      
      containers:
      #@overlay/match by="name"
      - name: runner
        image: ghcr.io/actions/actions-runner:latest
        command: ["/home/runner/run.sh"]
        #@overlay/match missing_ok=True
        env: []
        #@overlay/match missing_ok=True
        volumeMounts:
        #@overlay/append
        - name: work
          mountPath: /home/runner/_work
      
      #! Add dind sidecar container
      #@overlay/append
      - name: dind
        image: docker:dind
        securityContext:
          privileged: true
        env:
        - name: DOCKER_TLS_CERTDIR
          value: ""
        volumeMounts:
        - name: work
          mountPath: /home/runner/_work
        - name: dind-storage
          mountPath: /var/lib/docker
      
      #@overlay/match missing_ok=True
      volumes:
      #@overlay/append
      - name: work
        emptyDir: {}
      - name: dind-storage
        emptyDir: {}
