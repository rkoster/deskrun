#@ load("@ytt:overlay", "overlay")

#! Add create/delete/get/patch permissions for roles, rolebindings, and serviceaccounts
#! The ARC controller needs these to:
#! - Dynamically create roles for listener pods
#! - Remove finalizers during cleanup (requires patch permission)
#! Original upstream only has: list, watch, patch for roles; list, watch for rolebindings; list, watch for serviceaccounts
#! We need: create, delete, get, list, patch, watch for roles
#!          create, delete, get, list, patch, watch for rolebindings
#!          create, delete, get, list, patch, watch for serviceaccounts
#@overlay/match by=overlay.subset({"kind": "ClusterRole", "metadata": {"name": "arc-controller-gha-rs-controller"}})
---
rules:
#@overlay/match by=overlay.subset({"resources": ["rolebindings"]})
-
  #@overlay/replace
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - watch
#@overlay/match by=overlay.subset({"resources": ["roles"]})
-
  #@overlay/replace
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - watch
#@overlay/match by=overlay.subset({"resources": ["serviceaccounts"]})
-
  #@overlay/replace
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - watch

#! Add 'list' permission to secrets in manager_listener_role
#! The ARC controller needs to list runner-linked secrets during EphemeralRunner finalization
#! Without this permission, finalizers get stuck and resources cannot be properly cleaned up
#! Original upstream has: create, delete, get, patch, update
#! We need: create, delete, get, list, patch, update
#@overlay/match by=overlay.subset({"kind": "Role", "metadata": {"name": "arc-controller-gha-rs-controller-listener"}})
---
rules:
#@overlay/match by=overlay.subset({"resources": ["secrets"]})
-
  #@overlay/replace
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - update
