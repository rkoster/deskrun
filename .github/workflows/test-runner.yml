name: Test Self-Hosted Runner

on:
  push:
    branches: [copilot/implement-github-actions-runner]
  workflow_dispatch:

jobs:
  test:
    runs-on: test-runner
    container:
      image: docker:dind
      options: --privileged --init
    steps:
      - name: Check container capabilities
        run: |
          echo "=== Container Diagnostics ==="
          echo "Running as UID: $(id -u)"
          echo "User: $(whoami)"
          echo "Groups: $(groups)"
          echo ""
          echo "=== Checking privileged mode ==="
          cat /proc/self/status | grep Cap
          echo ""
          echo "=== Checking cgroups ==="
          mount | grep cgroup || echo "No cgroup mounts found"
          echo ""
          echo "=== Checking for docker ==="
          which docker
          which dockerd
          docker --version
          dockerd --version
          echo ""
          echo "=== Checking /sys/fs/cgroup ==="
          ls -la /sys/fs/cgroup/ | head -20
      - name: Start Docker daemon
        run: |
          # docker:dind image already has docker daemon configured
          # Wait for it to be ready
          echo "Waiting for Docker daemon to be ready..."
          timeout=120
          attempt=0
          while ! docker info >/dev/null 2>&1; do
              attempt=$((attempt + 1))
              echo "Attempt $attempt/120: Waiting for Docker daemon..."
              
              sleep 1
              timeout=$((timeout - 1))
              if [ "$timeout" -le 0 ]; then
                  echo "Error: Docker daemon failed to start within 120 seconds"
                  docker info || true
                  exit 1
              fi
          done

          echo "Docker daemon is ready!"
          docker info

      - uses: actions/checkout@v4
      - name: Run simple test
        run: |
          echo "Running on ARC scale set runner in container"
          echo "Hostname: $(hostname)"
          echo "Username: $(whoami)"
          id
      - name: Test container environment
        run: |
          echo "Testing container environment"
          cat /etc/os-release
          echo "---"
          apt-get update -qq && apt-get install -y -qq curl > /dev/null 2>&1
          curl --version
      - name: Test Docker in container
        run: |
          export DOCKER_HOST=unix:///tmp/dind/docker.sock
          echo "Testing Docker availability"
          docker info
          docker ps
          echo "Docker is working!"
